# Синхронизация отзывов из 2ГИС

## Описание

Система для автоматической синхронизации отзывов из 2ГИС в базу данных Supabase.

## Использование

### Через админ-панель

1. Войдите в админ-панель: `/admin/login`
2. Прокрутите вниз до секции "Синхронизация отзывов"
3. Нажмите кнопку "Синхронизировать отзывы из 2ГИС"
4. Дождитесь завершения синхронизации

### Через API

```bash
POST /api/testimonials/sync
```

Требует авторизации (JWT токен в cookies).

## Важные замечания

### ⚠️ Ограничения парсинга 2ГИС

2ГИС загружает отзывы **динамически через JavaScript**, поэтому простой HTTP запрос может не получить полный HTML с отзывами.

**Если автоматический парсинг не работает:**

1. **Используйте Puppeteer** (для серверного рендеринга)
2. **Ручной импорт** через админ-панель (добавить форму для ручного ввода)
3. **Периодическая синхронизация** через cron job с использованием headless браузера

### Альтернативные методы

#### Метод 1: Ручной импорт отзывов

Используйте API для ручного добавления:

```bash
POST /api/testimonials
Content-Type: application/json
Cookie: auth_token=...

{
  "initials": "М.Б.",
  "text": "Текст отзыва..."
}
```

#### Метод 2: Использование Puppeteer

Для более надежного парсинга можно использовать Puppeteer:

```typescript
import puppeteer from 'puppeteer';

const browser = await puppeteer.launch();
const page = await browser.newPage();
await page.goto(DGIS_REVIEWS_URL);
await page.waitForSelector('.review'); // Дождаться загрузки отзывов
const html = await page.content();
// Парсинг HTML...
```

## Структура данных

Отзывы сохраняются в таблицу `testimonials`:

- `id` (UUID) - уникальный идентификатор
- `initials` (TEXT) - инициалы автора (например, "М.Б.")
- `text` (TEXT) - текст отзыва
- `created_at` (TIMESTAMP) - дата создания

## Проверка работы

1. Проверьте, что отзывы загружаются на сайте в секции "Отзывы"
2. Проверьте в Supabase Table Editor → `testimonials`
3. Проверьте логи сервера на ошибки парсинга

## Устранение проблем

### Проблема: "No reviews found"

**Причина:** HTML структура 2ГИС изменилась или отзывы загружаются динамически.

**Решение:**
- Обновите селекторы в функции `parseReviewsFromHTML`
- Используйте Puppeteer для полного рендеринга страницы
- Используйте ручной импорт

### Проблема: "Failed to fetch 2GIS page"

**Причина:** 2ГИС блокирует запросы или требует авторизацию.

**Решение:**
- Проверьте User-Agent в заголовках
- Добавьте больше заголовков для имитации браузера
- Используйте прокси

## Будущие улучшения

- [ ] Интеграция с Puppeteer для надежного парсинга
- [ ] Автоматическая синхронизация по расписанию (cron)
- [ ] Форма для ручного добавления отзывов в админ-панели
- [ ] Кэширование отзывов для уменьшения нагрузки
- [ ] Фильтрация дубликатов при синхронизации

